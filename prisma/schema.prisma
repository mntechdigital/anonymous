// Facebook Page Automation Platform
// Multi-tenant system with 3 user roles:
// 1. Super Admin - Full access to all organizations, pages, and analytics
// 2. Admin - Organization-level access
// 3. Page Owner - Facebook login users with page-specific access

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

enum UserRole {
    SUPER_ADMIN // Full system access
    ADMIN // Organization admin
    PAGE_OWNER // Facebook authenticated user
}

enum AuthProvider {
    LOCAL // JWT-based (Super Admin, Admin)
    FACEBOOK // OAuth Facebook (Page Owner)
}

model User {
    id           String       @id @default(cuid())
    email        String       @unique
    name         String
    password     String? // Null for Facebook users
    role         UserRole     @default(PAGE_OWNER)
    authProvider AuthProvider @default(LOCAL)

    // Facebook OAuth data (only for PAGE_OWNER)
    facebookId    String? @unique
    facebookToken String? @db.Text // Long-lived user token

    // Organization relationship
    organizationId String?
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

    // Relations
    pages          FacebookPage[]
    posts          Post[]
    scheduledPosts ScheduledPost[]
    pageAccess     PageAccess[]
    accessGranted  PageAccess[]    @relation("GrantedBy")
    activityLogs   ActivityLog[]

    isActive    Boolean   @default(true)
    lastLoginAt DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    @@index([email])
    @@index([facebookId])
    @@index([organizationId])
    @@map("users")
}

// ============================================
// ORGANIZATION MANAGEMENT
// ============================================

model Organization {
    id          String  @id @default(cuid())
    name        String
    slug        String  @unique
    description String?

    // Relations
    users          User[]
    pages          FacebookPage[]
    posts          Post[]
    scheduledPosts ScheduledPost[]

    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([slug])
    @@map("organizations")
}

// ============================================
// FACEBOOK PAGE MANAGEMENT
// ============================================

model FacebookPage {
    id              String @id @default(cuid())
    pageId          String @unique // Facebook Page ID
    pageName        String
    pageAccessToken String @db.Text // Long-lived page access token (encrypted)

    // Page metadata
    category String?
    about    String? @db.Text
    website  String?
    phone    String?
    email    String?

    // Page stats
    fanCount       Int @default(0)
    followersCount Int @default(0)

    // Media
    profilePictureUrl String?
    coverPhotoUrl     String?

    // Organization & User
    organizationId String?
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

    addedById String
    addedBy   User   @relation(fields: [addedById], references: [id])

    // Relations
    posts          Post[]
    scheduledPosts ScheduledPost[]
    pageAnalytics  PageAnalytics[]
    pageAccess     PageAccess[]

    isActive       Boolean   @default(true)
    tokenExpiresAt DateTime? // Track token expiration if applicable
    lastSyncAt     DateTime? // Last time page data was synced
    createdAt      DateTime  @default(now())
    updatedAt      DateTime  @updatedAt

    @@index([pageId])
    @@index([organizationId])
    @@index([addedById])
    @@map("facebook_pages")
}

// ============================================
// PAGE ACCESS CONTROL (Permissions)
// ============================================

model PageAccess {
    id String @id @default(cuid())

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    pageId String
    page   FacebookPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

    // Permissions
    canView     Boolean @default(true)
    canPost     Boolean @default(false)
    canSchedule Boolean @default(false)
    canDelete   Boolean @default(false)
    canManage   Boolean @default(false) // Edit page settings

    grantedById String?
    grantedBy   User?   @relation("GrantedBy", fields: [grantedById], references: [id], onDelete: SetNull)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, pageId])
    @@index([userId])
    @@index([pageId])
    @@map("page_access")
}

// ============================================
// POST MANAGEMENT
// ============================================

enum PostType {
    TEXT
    LINK
    PHOTO
    VIDEO
    CAROUSEL
}

enum PostStatus {
    DRAFT
    PUBLISHED
    FAILED
    DELETED
}

model Post {
    id     String  @id @default(cuid())
    postId String? @unique // Facebook Post ID (after publishing)

    // Content
    message      String?  @db.Text
    type         PostType @default(TEXT)
    link         String?
    mediaUrl     String? // Photo/Video URL
    thumbnailUrl String?

    status PostStatus @default(DRAFT)

    // Publishing info
    publishedAt DateTime?
    permalink   String? // Facebook post URL

    // Relations
    pageId String
    page   FacebookPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

    organizationId String?
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

    createdById String
    createdBy   User   @relation(fields: [createdById], references: [id])

    // Analytics
    analytics PostAnalytics?

    errorMessage String? @db.Text // Store error if publishing failed

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([postId])
    @@index([pageId])
    @@index([organizationId])
    @@index([createdById])
    @@index([status])
    @@index([publishedAt])
    @@map("posts")
}

// ============================================
// SCHEDULED POSTS
// ============================================

enum ScheduledPostStatus {
    PENDING
    PROCESSING
    PUBLISHED
    FAILED
    CANCELLED
}

model ScheduledPost {
    id             String  @id @default(cuid())
    facebookPostId String? @unique // FB scheduled post ID

    // Content
    message  String?  @db.Text
    type     PostType @default(TEXT)
    link     String?
    mediaUrl String?

    // Scheduling
    scheduledTime DateTime
    status        ScheduledPostStatus @default(PENDING)

    // Relations
    pageId String
    page   FacebookPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

    organizationId String?
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

    createdById String
    createdBy   User   @relation(fields: [createdById], references: [id])

    // Publishing result
    publishedPostId String? // Reference to Post after publishing
    errorMessage    String?   @db.Text
    publishedAt     DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([pageId])
    @@index([organizationId])
    @@index([createdById])
    @@index([scheduledTime])
    @@index([status])
    @@map("scheduled_posts")
}

// ============================================
// ANALYTICS
// ============================================

model PostAnalytics {
    id String @id @default(cuid())

    postId String @unique
    post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

    // Engagement metrics
    impressions  Int @default(0)
    reach        Int @default(0)
    engagedUsers Int @default(0)

    // Interactions
    likesCount    Int @default(0)
    commentsCount Int @default(0)
    sharesCount   Int @default(0)

    // Reactions breakdown
    reactionsLove  Int @default(0)
    reactionsWow   Int @default(0)
    reactionsHaha  Int @default(0)
    reactionsSad   Int @default(0)
    reactionsAngry Int @default(0)

    // Video metrics (if applicable)
    videoViews    Int @default(0)
    videoViewTime Int @default(0) // in seconds

    // Clicks
    linkClicks  Int @default(0)
    otherClicks Int @default(0)

    lastSyncedAt DateTime @default(now())
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    @@index([postId])
    @@map("post_analytics")
}

model PageAnalytics {
    id String @id @default(cuid())

    pageId String
    page   FacebookPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

    date DateTime @db.Date

    // Daily metrics
    impressions     Int @default(0)
    reach           Int @default(0)
    engagedUsers    Int @default(0)
    postEngagements Int @default(0)
    pageViews       Int @default(0)

    // Fan metrics
    newLikes  Int @default(0)
    totalFans Int @default(0)

    // Video metrics
    videoViews Int @default(0)

    // Negative feedback
    negativeFeedback Int @default(0)

    lastSyncedAt DateTime @default(now())
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    @@unique([pageId, date])
    @@index([pageId])
    @@index([date])
    @@map("page_analytics")
}

// ============================================
// AUDIT & ACTIVITY LOGS
// ============================================

enum ActivityType {
    USER_LOGIN
    USER_LOGOUT
    PAGE_ADDED
    PAGE_REMOVED
    POST_CREATED
    POST_PUBLISHED
    POST_UPDATED
    POST_DELETED
    POST_SCHEDULED
    PERMISSION_GRANTED
    PERMISSION_REVOKED
    ANALYTICS_SYNCED
}

model ActivityLog {
    id String @id @default(cuid())

    userId String?
    user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

    activityType ActivityType
    description  String       @db.Text
    metadata     Json? // Additional data (page ID, post ID, etc.)
    ipAddress    String?
    userAgent    String?      @db.Text

    createdAt DateTime @default(now())

    @@index([userId])
    @@index([activityType])
    @@index([createdAt])
    @@map("activity_logs")
}

// ============================================
// SYSTEM SETTINGS & CONFIGURATION
// ============================================

model SystemSettings {
    id          String  @id @default(cuid())
    key         String  @unique
    value       String  @db.Text
    description String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("system_settings")
}
